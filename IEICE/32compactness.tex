
\begin{lem}\label{片方}
Let $\sharp \Sigma \ge 3$ and $p,~q$ regular patterns on $\Sigma$.
Suppose that the finite set $D$ of regular patterns is one of the following {\rm (i), (ii)}.
Then, if $p \{ x := r \} \preceq q$ for all $r \in D$, then $p \{ x := xy \} \preceq q$.
\begin{enumerate}
\item[{\rm (i)}] $D=\{ ya, bc, dy \}$ $(b = a,~c \not = a,d,\mbox{~and~} b \not = d)$,
\item[{\rm (ii)}] $D=\{ ya, bc, dy \}$ $(b \not = a,d,~c = d,\mbox{~and~} c \not = a)$.
\end{enumerate}
\end{lem}
\begin{proof}

It is obvious if no variable symbol appears in $p$.
Therefore, let $p=p_{1}xp_{2}$ ($p_{1}, p_{2}$ are regular patterns and $x$ is a variable symbol). Assume that $p \{ x := xy \} \not \preceq q$ and derive the contradiction.

\noindent\textrm{(i)}
Let $D=\{ ya, bc, dy \}$ $(b = a,~c \not = a,d,\mbox{~and~}b \not = d)$.
Since $p \{ x := r \} \preceq q$ for all $r \in D$, there are three strings of length $2$ corresponding to $ya, bc, dy$ in $q$. Note that the three strings may appear partly overlapping.
The symbols appearing in $D$ corresponds to a variable or a constant in $q$.
Let $y_{1}, y_{2}, y_{3}$ be variable symbols appearing in $q$.
The strings $ya$ and $dy$ must correspond to the strings $y_{1}a$ and $dy_{3}$ in $q$, respectively.
There are the following three possibilities of strings in $q$ which corresponds to $bc$ in $p\{x:=bc\}$.
\begin{center}
\begin{tabular}{cccccc}
\textrm{(a)} & $bc$, &
\textrm{(b)} & $y_{2}c$, &
\textrm{(c)} & $by_{2}$.
\end{tabular}
\end{center}

\textrm{(a)}
Let $A,B,C$ be strings where $\{ A,B,C \} = \{ y_{1}a,bc,dy_{3} \}$ and let $q=q_{1}AwBw^{\prime}Cq_{2}$.
Since $p \{ x := r \} \preceq q$ for all $r \in D$ and $p \{ x := xy \} \not \preceq q$ hold, the following conditions hold:
\begin{align*}
(1)~& p_{1} \preceq q_{1} & (1')~& p_{2} \preceq wBw^{\prime}Cq_{2} \\
(2)~& p_{1} \preceq q_{1}Aw & (2')~& p_{2} \preceq w^{\prime}Cq_{2} \\
(3)~& p_{1} \preceq q_{1}AwBw^{\prime} & (3')~& p_{2} \preceq q_{2}
\end{align*}

Let $q^{\prime}_{1}=q_{1}A,~q^{\prime}_{2}=wBw^{\prime},~q^{\prime}_{3}=Cq_{2}$. From $(3)$ and $(1')$, we have $p_{1} \preceq q^{\prime}_{1}q^{\prime}_{2},~p_{2} \preceq q^{\prime}_{2}q^{\prime}_{3}$.
From Lemma \ref{補題9}, if $q^{\prime}_{2}$ contains a variable, $p \preceq q$ holds.
Therefore, $B$ must be $bc$.
If $A=dy_{3}$, from $(2)$, $p_{1} \preceq q_{1}dy_{3}w$ holds.
Let $p_{1}=p^{\prime}_{1}p^{\prime\prime}_{1}, p^{\prime}_{1} \preceq q_{1}d$, and $p^{\prime\prime}_{1} \preceq y_{3}w$.
From $(1')$, we have $p=p_{1}xp_{2}=p^{\prime}_{1}p^{\prime\prime}_{1}xp_{2} \preceq q_{1}dp^{\prime\prime}_{1}xwbcw^{\prime}y_{1}aq_{2}=q \{ x:=p^{\prime\prime}_{1}x \}$. This shows that there is a substitution $\theta$ such that $p=q\theta$ holds, and this contradicts to the assumption. Therefore, we only need to consider the case where $A=y_{1}a,B=bc$, and $C=dy_{3}$.

From the above, we consider two cases: one in which the symbols overlap and the other in which they do not.
\smallskip

\begin{tabular}{cl}
\textrm{(a-1)} & $q=q_{1}y_{1}awbcw^{\prime}dy_{3}q_{2}$,\\
\textrm{(a-2)} & $q=q_{1}y_{1}acwdy_{3}q_{2}$~~($a=b$).
\end{tabular}
\smallskip

\textrm{(a-1)}
From the proof of Lemma \ref{追加部分}, $p \{ x:= xy \} \preceq q$ holds.
Therefore, it contradicts the assumption.

\textrm{(a-2)}
Let $q=q_{1}y_{1}acwdy_{3}q_{2}$ ($a=b$).
For this $q$, the following conditions hold:
\begin{align*}
(1)~& p_{1} \preceq q_{1} & (1')~& p_{2} \preceq cwdy_{3}q_{2} \\
(2)~& p_{1} \preceq q_{1}y_{1} & (2')~& p_{2} \preceq wdy_{3}q_{2} \\
(3)~& p_{1} \preceq q_{1}y_{1}acwdy_{3} & (3')~& p_{2} \preceq q_{2}
\end{align*}

%
If $|w|=0$, from $(1')$ and $(2')$, the prefix of $p_{2}$ is $cd$ and $d$.
Therefore, $c=d$. This contradicts the fact that $c \not = d$.

If $|w|=1$, from (1') and (2'), the prefix of $p_{2}$ is $cwd$ and $wd$.
Therefore, $w=c=d$.
This contradicts to the fact that $c \not = d$.

If $|w| \ge 2$, then from $(1')$ and $(2')$,  prefixes of $p_{2}$ is $cwd$ and $wd$.
Let $w$ be $w_{1}w_{2}w_{3} \cdots w_{n-1}w_{n}$ $(n\geq 2,~w_{i}\in\Sigma$ for $i=1, \ldots , n)$.
From $cw=wd$, a prefix of $w$ is $c$ and a suffix of $w$ is $d$.
Therefore, we have $w=cw_{2}w_{3} \cdots w_{n-1}d$.
Since $cw=cw_{2}w_{3} \cdots w_{n-1}d,~wd=cw_{2}w_{3} \cdots w_{n-1}dd$, from $cw=wd$, $w_{i}=w_{i+1}$ holds for $i=2, \ldots , n-2$.
Therefore, $c=d$. This contradicts to the fact that $c \not = d$.

\textrm{(b)}
Let $q=q_{1}AwBw^{\prime}Cq_{2}$ where $\{ A,B,C \} = \{ y_{1}a,y_{2}c,dy_{3} \}$, and let $q=q_{1}AwBw^{\prime}Cq_{2}$.
Since $c \not = a$ holds, $q$ have a substring that is corresponding to (i-2) of Lemma~\ref{変数2つ}.
Therefore, $p \{ x:= xy \} \preceq q$ holds.
This contradicts the assumption. 

\textrm{(c)} As in (b), this contradicts to the assumption.

\noindent\textrm{(ii)}
In this case, by reversing the strings $p$ and $q$, we can prove that the assumption $p \{ x := xy \} \preceq q$ is contradicted, as in the case of \textrm{(i)}.
\end{proof}

From Lemmas \ref{追加部分} and \ref{片方}, we obtain the following corollary:

\begin{col}\label{両方}
  Let $\sharp \Sigma \ge 3$ and $p, q$ regular patterns on $\Sigma$.
  For a variable symbol $y$, if $D= \{ ya, bc, dy \}$ $(b = a$ and $c = d)$, there exists $q$ such that $p \{ x := r \} \preceq q$ for any $r \in D$, then $p \{ x := xy \} \not \preceq q$.
\end{col}
\begin{ex}
Let $a,b,c,d,e$ be constant symbols in $\Sigma$ and 
$x,y,y_{1},y_{2}$ variable symbols.
Let 
\begin{align*}
p &= eabcbcadabcbcadaxbcadadabcbcadade,\\
q &= y_{1}abcbcadabcbcadady_{2}~~~~~(b = a\mbox{~and~}c = d).
\end{align*}

\noindent
Obviously $p \{ x:=xy \} \not \preceq q$ holds.
For these $p$ and $q$, the condition for Corollary \ref{両方} holds as follows (see also Fig.~\ref{b=aとc=dの例}):
\begin{eqnarray*}
&p& \{ x:=ya \} \\ 
& = & (eabcbcadabcbcaday)abcadadabcbcadade\\
& = & q \{ y_{1} := eabcbcadabcbcaday_{1} \} \\
& \preceq & q,\\
&p& \{ x:=bc \}  \\
& = & (eabcbcad)abcbcadabcbcadad(abcbcadade) \\
& = & q \{ y_{1} := eabcbcad,~y_{2} := abcbcadade \} \\
& \preceq & q,\\
&p& \{ x:=dy \}  \\
& = & eabcbcadabcbcadad(ybcadadabcbcadade) \\
& = & q \{ y_{2} := y_{2}bcadadabcbcadade \} \\
& \preceq & q.
\end{eqnarray*}
\end{ex}

\begin{figure}[t]
\includegraphics[width=\linewidth]{figs/Exam_b=a_c=d.png}
\caption{Substitutions for $p$ and each relation to $q$.}
\label{b=aとc=dの例}
\end{figure}

\begin{comment}
\begin{lem}\label{追加補題2}
Let $\sharp \Sigma \ge 3$ and $p, q$ regular patterns on $\Sigma$.
Let $D= \{ ya，ab，by，cd \}$ $(cd \not = ab)$ be a set consisting of constant symbols $a,b,c,d$ in $\Sigma$ and a variable symbol $y$.
If for all $r \in D$, $p \{ x := r \} \preceq q holds, then $p \{ x := xy \} \preceq q$ holds.
\end{lem}
\begin{proof}
$p$に変数記号が現れない場合は自明である．
したがって，$p=p_{1}xp_{2}$ ($p_{1}, p_{2}$は正規パターン, $x$は変数記号)とおく．$p \{ x := xy \} \not \preceq q$と仮定して，矛盾を導く．

$c \not = a$かつ$d \not = b$であるとき，系\ref{両方}より，$p \{ x:= xy \} \preceq q$となる．
これは，仮定に矛盾する．

$c \not = a$かつ$d = b$，または，$c = a$かつ$d \not = b$であるとき，補題\ref{片方}より，$p \{ x:=xy \} \preceq q$となる．
これは，仮定に矛盾する．
\end{proof} 
\end{comment}
%\begin{lem}\label{追加補題1}
%$k \ge 3$，$m \ge \sqrt{k+1}$，$\sharp \Sigma \ge k+m$，$P \in \RPatplus$，$Q \in \RPat^{k}$とする．
%すべての定数記号$a, b \in \Sigma$に対し，ある正規パターン$q \in Q$が存在し，
%$p \{ x:=ab \} \preceq q$ならば，$p \{ x:=xy \} \preceq q$となる．
%\end{lem}

\begin{lem}\label{追加補題1}
Let $\sharp \Sigma \ge k+2$ for $k\geq 1$. Let $p,q$ be regular patterns with $p \in \RPat$ and $Q \in \RPat^{k}$.
For any constant symbols $a, b \in \Sigma$, there exists a regular pattern $q \in Q$ such that if $p \{ x:=ab \} \preceq q$ holds, then $p \{ x:=xy \} \preceq q$ holds.
\end{lem}
\begin{proof}
If no variable symbol appears in $p$, this lemma is obvious.
For regular patterns $p_{1},p_{2}\in \RPat$ and a variable symbol $x$, let $p=p_{1}xp_{2}$.
And let $Q=\{ q_{1}, \ldots , q_{k} \}\in \RPat^{k}$.
The notations are defined as follows:
\begin{align*}
& A_{i} = \{ a \in \Sigma \mid p \{ x:=ay \} \preceq q_{i},\ y\in X\},\\ 
& B_{i} = \{ b \in \Sigma \mid p \{ x:=yb \} \preceq q_{i},\ y\in X\},\\ 
%& \tilde{B}_{i} = \{ \tilde{b} \in \Sigma \mid p \{ x:=yb \} \preceq q_{i},\ y\in X\},\\ 
& A = \bigcup_{i=1}^{k}A_{i},B = \bigcup_{i=1}^{k} B_{i},\\
& \tilde{B} = \{ \tilde{b} \mid b \in B \},\\
& A^{\prime} = \Sigma\setminus A,~B^{\prime} = \Sigma\setminus B,\\
& \tilde{\Sigma} = \{ \tilde{c} \mid c \in \Sigma \},\\
& \tilde{B}^{\prime} = \{ b \mid b \in \tilde{\Sigma} \setminus \tilde{B} \}~~(i=1, \ldots , k).
\end{align*}

Assume that $p \{ x:=xy \} \not \preceq q_{i}$ \ ($i=1, \ldots , k$) holds.

$k=1$のとき，$p \{ x:=a_{1}a_{i} \} \preceq q_{1}$かつ$p \{ x:=a_{2}a_{i} \} \preceq q_{1}$ ($i=1,2,3$)となる．
$p^{\prime} = p \{ x:=a_{1}y \} = p_{1}a_{1}yp_{2}$とおくと，$p \{ x:=a_{1}a_{i} \} \preceq q_{1}$より，$p^{\prime} \{ y:=a_{i} \} \preceq q_{1}$となる．
$a_{i}$は互いに異なる定数記号であるため，補題\ref{補題10}より，$p^{\prime} \preceq q_{1}$となる．
よって，$p \{ x:=a_{1}y \} \preceq q_{1}$となる．
$p \{ x:=a_{2}y \}$についても同様に考えることができ，$p \{ x:=a_{2}y \} \preceq q_{1}$となる．
したがって，$p \{ x:=a_{1}y \} \preceq q_{1}$かつ$p \{ x:=a_{2}y \} \preceq q_{1}$であるため，補題\ref{変数2つ}より，$p \{ x:= xy \} \preceq q_{1}$となる．
これは，仮定に矛盾する．

$k \ge 2$のとき，2部グラフを用いて矛盾を導く．
$G=(\Sigma,\tilde{\Sigma}; A^{\prime} \times \tilde{B}^{\prime})$
を$\Sigma$と$\tilde{\Sigma}$を部集合とし，$A^{\prime} \times \tilde{B}^{\prime}$を辺集合とする2部グラフとする．
$\Sigma$と$\tilde{\Sigma}$を部集合とし，$\tilde{E}_{i}=\{ (a, \tilde{b}) \in A^{\prime} \times \tilde{B}^{\prime} \mid p \{ x:=ab \} \preceq q_{i} \}$を辺集合とする2部グラフを$\tilde{G}_{i}=(\Sigma,\tilde{\Sigma}; \tilde{E}_{i})$とする．

$\sharp A_{i} \ge 2$または$\sharp B_{i} \ge 2$となる$i$が存在するとき，補題\ref{変数2つ}より，$p \{ x:=xy \} \preceq q_{i}$となる．
これは仮定に矛盾する．よって，任意の$i$ ($i=1, \ldots , k$)に対して，$\sharp A_{i} \le 1$かつ$\sharp B_{i} \le 1$となる．
また，$0 \le \sharp A \le k$かつ$0 \le \sharp\tilde{B} \le k$となり，$2 \le \sharp A^{\prime} \le k+2$かつ$2 \le \sharp \tilde{B}^{\prime} \le k+2$となる．
$\sharp A=k$かつ$\sharp \tilde{B}=k$である$G$を$G^{(k,~k)}$と表し，$\sharp A_{i}=1$かつ$\sharp B_{i}=1$である$\tilde{G}_{i}$を$\tilde{G}^{(1,~1)}_{i}$と表す．

$\sharp A$と$\sharp \tilde{B}$の関係を，次の3つの場合に分けて証明する．
\[
\begin{tabular}{ll}
$\textbf{(1)}$ $\sharp A=k$かつ$\sharp \tilde{B} \le k$,\\
$\textbf{(2)}$ $\sharp A = k-1$かつ$\sharp \tilde{B} \le k-1$,\\
$\textbf{(3)}$ $\sharp A \le k-2$かつ$\sharp \tilde{B} \le k-2$,
\end{tabular}
\]
\begin{figure*}[t]
\centering
\includegraphics[width=\linewidth]{figs/ComparingBipartiteGraph.png}
%\vspace{-1cm}
\caption{(1-1)，(1-2)，(1-3)の例}
\label{グラフ比較}
\end{figure*}

\noindent\textbf{(1)} 
$\sharp A=k$かつ$\sharp \tilde{B} \le k$であるとき，$\sharp A^{\prime}=2$かつ$\sharp \tilde{B}^{\prime} \ge 2$となる．
このとき，$G$には少なくとも$\sharp A^{\prime} \times \sharp \tilde{B}^{\prime}=2\times2=4$本の辺が含まれる．
図\ref{グラフ比較}のように，$| A^{\prime} \cap B^{\prime} |$の関係は，3種類に分けられる．
よって，以下のように，場合分けして証明する．
\[
\begin{tabular}{ll}
$\textbf{(1-1)}$ $| A^{\prime} \cap B^{\prime} | = 0$，$\textbf{(1-2)}$ $| A^{\prime} \cap B^{\prime} | = 1$，\\
$\textbf{(1-3)}$ $| A^{\prime} \cap B^{\prime} | = 2$.
\end{tabular}
\]

\textbf{(1-1)} 
$\sharp A = k$かつ$\sharp \tilde{B} = k$であるとき，
$p \{ x:=ya_{i} \} \preceq q_{i}$かつ$p \{ x:=a_{i}y \} \preceq q_{i}$ $(i=3,\ldots,k)$とし，$p \{ x:=a_{j}y \} \preceq q_{j}$かつ$p \{ x:=ya_{k+j} \} \preceq q_{j}$ $(j=1,2)$とする．

%\begin{figure}[H]
\begin{figure}[t]
\centering
\includegraphics[width=\linewidth]{figs/Exam-BipartiteGraph-Corollary.png}
%\vspace{-1cm}
\caption{系\ref{両方}の条件に当てはまるパターンにおける二分グラフの例}
\label{系との関係}
%\vspace*{-.5cm}
\end{figure}

系\ref{両方}より，$p \{ x:=a_{k+1}a_{1} \} \preceq q_{1}$(図\ref{系との関係})，$p \{ x:=a_{k+2}a_{2} \} \preceq q_{2}$となる$q_{1},~q_{2}$が考えられる．

このとき，$\tilde{G}_{1}$と$\tilde{G}_{2}$に含まれる辺はそれぞれ1本となる．
$G$に含まれる辺は，4本であるため，残り$4-2=2$本の辺は$\tilde{G}_{i}$ $(i=3, \ldots, k)$に含まれる．
すなわち，$p \{ x:=a_{k+1}a_{2} \} \preceq q_{i_{0}}$と$p \{ x:=a_{k+2}a_{1} \} \preceq q_{i_{1}}$となる$q_{i_{0}}$と$q_{i_{1}}$が存在する．
任意の$i$ $(i=3, \ldots, k)$に対して，$p \{ x:=ya_{i} \} \preceq q_{i}$かつ$p \{ x:=a_{i}y \} \preceq q_{i}$であるため，$q_{i_{0}},q_{i_{1}} \in Q \setminus \{ q_{1},q_{2} \}$より，$a_{k+1} \not = a_{i}$かつ$a_{2} \not = a_{i}$となる．
よって，補題\ref{追加部分}より，$p \{ x:=xy \} \preceq q_{i_{0}}$となり，仮定に矛盾する．

$\sharp A = k$かつ$\sharp \tilde{B} < k$であるとき，$\sharp A_{i}=1$かつ$\sharp B_{i}=0$となる$i$が存在する．

%\begin{figure}[H]
\begin{figure}[t]
\centering
\includegraphics[width=\linewidth]{figs/BipartiteGraph-diff-ab.png}
%\vspace{-1cm}
\caption{$\sharp A_{k} =1$かつ$\sharp B_{k}=1$の場合と$\sharp A_{k}=1$かつ$\sharp B_{k}=0$の場合の$G$に含まれる辺数の違い}
\label{abが異なる場合}
\end{figure}

図\ref{abが異なる場合}のように，$G^{(k,~k-1)}$に含まれる辺の本数は，$G^{(k,~k)}$と比べて，$\sharp A^{\prime}$本多くなる．
すなわち，ある$\tilde{G}^{(1,~1)}_{i}$が$\tilde{G}^{(1,~0)}_{i}$となった場合，全体の$G$に含まれる辺の本数は，$\sharp A^{\prime}$本多くなる．
このことから，$G^{(k,~k-1)}$の部分グラフ$\tilde{G}^{(1,~0)}_{i}$に含まれる辺の本数が$\sharp A^{\prime}$本以下であるとき，$G^{(k,~k)}$における結果と同様となる．
一方で，$G^{(k,~k-1)}$の部分グラフ$\tilde{G}^{(1,~0)}_{i}$に$\sharp A^{\prime}+1=2+1=3$本以上の辺が含まれるとき，$G^{(k,~k)}$における結果から変化する可能性がある．

$G^{(k,~k-2)}$の部分グラフ$\tilde{G}^{(1,~0)}_{i_{0}}$と$\tilde{G}^{(1,~0)}_{i_{1}}$が，それぞれ$3$本の辺を含むとき，以下のような例が考えられる．

\begin{ex}\label{少なくなるとき}
${G}^{(k,~k-2)}$の部分グラフ$\tilde{G}^{(1,~0)}_{k-1}$と$\tilde{G}^{(1,~0)}_{k}$に$\sharp A^{\prime}+1=2+1=3$本の辺が含まれるとき，
\begin{description}
\item[$(\mathrm{i})$] $p \{ x:= a_{i}y \} \preceq q_{i}$かつ$p \{ x:= ya_{i} \} \preceq q_{i}$ $(i=3, \ldots , k-2)$,
\item[$(\mathrm{ii})$] $p \{ x:=a_{j}y \} \preceq q_{j},~p \{ x:=ya_{k+j} \} \preceq q_{j}$かつ$p \{ x:=a_{k+j}a_{j} \} \preceq q_{j}$ $(j=1,2)$,
\item[$(\mathrm{iii})$] $p \{ x:=a_{k-1}y \} \preceq q_{k-1},~p \{ x:=a_{z}a_{k-1} \} \preceq q_{k-1}$かつ$p \{ x:=a_{1}a_{k+2} \} \preceq q_{k-1}$ \\$(z=k+1,k+2)$,
\item[$(\mathrm{iv})$] $p \{ x:=a_{k}y \} \preceq q_{k},~p \{ x:=a_{z}a_{k} \} \preceq q_{k}$かつ$p \{ x:=a_{2}a_{k+1} \} \preceq q_{k}$.
\end{description}
となる$p$と$q_{i}$ $(i=1,\ldots,k)$が存在し，$p \{ x:=xy \} \not \preceq q_{i}$となる．
\end{ex}
%例\ref{少なくなるとき}において，$G^{(k，k)}$の部分グラフ$\tilde{G}_{i}，\tilde{G}_{j}$と$G^{(k，k-2)}$の部分グラフ$\tilde{G}_{i}，\tilde{G}_{j}$に含まれる辺数は変わらない．
%よって，$\tilde{G}_{k-1}$と$\tilde{G}_{k}$に注目すればよい．
%$G^{(k，k)}$には$2 \times 2=4$本の辺が含まれ，$G^{(k，k-2)}$には$2 \times 4=8$本の辺が含まれる．
%$\sharp ((\tilde{A} \times \tilde{B}) \setminus E_{i})$は，$G^{(k，k)}$に含まれる辺の$\sharp (\tilde{A} \times \tilde{B})=4$本より少なくなる．
%(1)の場合，$\sharp\tilde{A} = 2$より，$\tilde{G}^{(1，0)}_{i}$に$2+1=3$本以上の辺が含まれるとき，$\sharp ((\tilde{A} \times \tilde{B}) \setminus E_{i})$は，$G^{(k，k)}$に含まれる辺の$\sharp (\tilde{A} \times \tilde{B})$本より少なくなる．
%$\tilde{G}^{(1，0)}_{k-1}$と$\tilde{G}^{(1，0)}_{k}$が，それぞれ$\sharp A^{\prime}+1$=3本の辺を持つ場合，$\tilde{G}_{i}$には辺は含まれない．
%よって，$p \{ x:=xy \} \not \preceq q_{i}$ $(i=1,\ldots,k)$となる．

%\begin{figure}[H]
\begin{figure}[t]
\centering
\includegraphics[width=\linewidth]{figs/BipartiteGraph-NumEdges-3.png}
%\vspace*{-1cm}
\caption{辺数が3である二分グラフの例}
\label{辺3におけるパターン}
\end{figure}

図\ref{辺3におけるパターン}のように，$\tilde{G}^{(1,~0)}_{i}$に3本の辺が含まれるパターンは，4つ存在する．
パターン1の場合，補題\ref{補題14}(abc)より，$p \{ x:=xy \} \preceq q_{i}$となる．
パターン2とパターン3の場合，互いに隣接しない辺が2本存在するため，
補題\ref{補題14}(d)より，$p \{ x:=xy \} \preceq q_{i}$となる．
パターン4の場合，$p \{ x:=a_{1}a_{j} \} \preceq q_{i}$ $(j=1,2,3)$となる．
$p^{\prime} = p \{ x:=a_{1}y \} = p_{1}a_{1}yp_{2}$とおくと，$p \{ x:=a_{1}a_{j} \} \preceq q_{i}$より，$p^{\prime} \{ y:=a_{j} \} \preceq q_{i}$となる．
$a_{j}$は互いに異なる定数記号であるため，補題\ref{補題10}より，$p^{\prime} \preceq q_{i}$となり，$p \{ x:=a_{1}y \} \preceq q_{i}$となる．
これは，$A_{i}$の定義に矛盾する．
よって，$\tilde{G}^{(1,~0)}_{i}$に含まれる辺は2本以下となる．
したがって，例\ref{少なくなるとき}は，$\tilde{G}^{(1,~0)}_{k-1}$と$\tilde{G}^{(1,~0)}_{k}$に含まれる辺がそれぞれ2本以下であることに矛盾する．

以上より，$G^{(k,~k)}$において，仮定に矛盾する場合，$\sharp A=k$かつ$\sharp \tilde{B}^{\prime} < k$である場合においても，仮定に矛盾する．
(2)，(3)のいずれの場合においても，$\sharp A^{\prime} > 2$であることから，同様のことが言える．

\textbf{(1-2)} 
$\sharp A = k$かつ$\sharp \tilde{B} = k$であるとき，
$p \{ x:=ya_{i} \} \preceq q_{i}$かつ$p \{ x:=a_{i}y \} \preceq q_{i}$ $(i=1,\ldots,k-1)$とし，$p \{ x:= ya_{k+2} \} \preceq q_{k}$かつ$p \{ x:= a_{k}y \} \preceq q_{k}$とする．
系\ref{両方}より，$p \{ x:=a_{k+2}a_{k} \} \preceq q_{k}$である$q_{k}$が考えられる．
このとき，$\tilde{G}_{k}$に含まれる辺は1本となる．
$G$に含まれる辺は，4本であるから，残り$4-1=3$本の辺は$\tilde{G}_{i}$ $(i=1, \ldots, k-1)$に含まれる．
すなわち，$p \{ x:=a_{k+1}a_{k+1} \} \preceq q_{i_{0}}$が存在する．
任意の$i$ $(i=1, \ldots, k-1)$に対して，$p \{ x:=ya_{i} \} \preceq q_{i}$かつ$p \{ x:=a_{i}y \} \preceq q_{i}$であるため，$q_{i_{0}} \in Q \setminus \{ q_{k} \}$より，$a_{k+1} \not = a_{i}$となる．
よって，補題\ref{追加部分}より，$p \{ x:=xy \} \preceq q_{i_{0}}$となり，仮定に矛盾する.

\textbf{(1-3)} 
$\sharp A = k$かつ$\sharp \tilde{B} = k$であるとき，
$p \{ x:=ya_{i} \} \preceq q_{i}$かつ$p \{ x:=a_{i}y \} \preceq q_{i}$ $(i=1,\ldots,k)$とする
$G$に$4$本の辺が含まれるため，$p \{ x:=a_{k+1}a_{k+1} \} \preceq q_{i_{0}}$が存在する．
よって，任意の$i$に対して，$a_{k+1} \not = a_{i}$となる．
補題\ref{追加部分}より，$p \{ x:=xy \} \preceq q_{i_{0}}$となり，仮定に矛盾する.

\begin{figure*}[t]
\centering
\includegraphics[width=\linewidth]{figs/Exam-Cases-(2).png}
%\vspace*{-1cm}
\caption{(2-1)，(2-2)，(2-3)，(2-4)の例}
\label{(2)におけるパターン}
\end{figure*}

\noindent\textbf{(2)} 
$\sharp A=k-1$かつ$\sharp B \le k-1$であるとき，$\sharp A^{\prime}=3$かつ$\sharp \tilde{B}^{\prime} \ge 3$となる．
$G$には少なくとも$\sharp A^{\prime} \times \sharp \tilde{B}^{\prime}=3\times3=9$本の辺が含まれる．
図\ref{(2)におけるパターン}のように，$| A^{\prime} \cap B^{\prime} |$の関係は，4種類に分けられる．よって，以下のように，場合分けして証明する．
\[
\begin{tabular}{ll}
$\textbf{(2-1)}$ $| A^{\prime} \cap B^{\prime} | = 0$，$\textbf{(2-2)}$ $| A^{\prime} \cap B^{\prime} | = 1$，\\
$\textbf{(2-3)}$ $| A^{\prime} \cap B^{\prime} | = 2$，$\textbf{(2-4)}$ $| A^{\prime} \cap B^{\prime} | = 3$．
\end{tabular}
\]

\textbf{(2-1)} 
$\sharp A=k-1$かつ$\sharp \tilde{B}=k-1$であるとき，
$p \{ x:=ya_{i} \} \preceq q_{i}$かつ$p \{ x:=a_{i}y \} \preceq q_{i}$ $(i=4, \ldots, k-1)$とし，$p \{ x:=ya_{j} \} \preceq q_{j}$かつ$p \{ x:=a_{k+j-1}y \} \preceq q_{j}$ $(j=1,2,3)$とする．
このとき，系\ref{両方}より，$p \{ x:=a_{j}a_{k+j-1} \} \preceq q_{j}$となる$q_{j}$が考えられる．
よって，$\tilde{G}_{j}$には，それぞれ1本の辺が含まれる．
$G$に含まれる辺は，9本であるから，残り$9-3=6$本の辺は$\tilde{G}_{i}$ $(i=4, \ldots, k)$に含まれる．
$\tilde{G}_{i}$ $(i=4, \ldots, k-1)$のいずれかに，辺が1本以上含まれる場合，$p \{ x:=ab \} \preceq q_{i}$ $(a \not = a_{i}$かつ$b \not = a_{i})$となる．
これは，補題\ref{追加部分}より，$p \{ x:=xy \} \preceq q_{i}$となるため，仮定に矛盾する．
よって，$\tilde{G}_{k}$には$6$本の辺が含まれる．
次数が3以上である頂点$a$が$\tilde{G}_{k}$に含まれるとき，補題\ref{補題10}より，$p \{x:=ay \} \preceq q_{k}$または$p \{ x:= ya \} \preceq q_{k}$となり，$A_{k}$または$B_{k}$の定義に矛盾する．
したがって，$\tilde{G}_{k}$に含まれる頂点の次数は2以下となる．

%\begin{figure}[H]
\begin{figure}[t]
\centering
\includegraphics[width=\linewidth]{figs/Exam-BipartiteGraph.png}
%\vspace*{-1cm}
\caption{辺数が5である二分グラフの例（各頂点の次数は2以下）}
\label{辺5本の場合}
\end{figure}

図\ref{辺5本の場合}のように，ある$\tilde{G}_{i}$に含まれる辺が5本であるとき，互いに隣接しない辺が3本以上存在する．
よって，補題\ref{補題14}(abc)より，$p \{x:=xy \} \preceq q_{k}$となる．
これは，仮定に矛盾する．

\textbf{(2-2)} 
$p \{ x:=ya_{i} \} \preceq q_{i}$かつ$p \{ x:=a_{i}y \} \preceq q_{i}$ $(i=1, \ldots, k-3)$とし，$p \{ x:=ya_{j+3} \} \preceq q_{j}$かつ$p \{ x:=a_{j}y \} \preceq q_{j}$ $(j=k-2,k-1)$とする．
このとき，系\ref{両方}より，$p \{ x:=a_{j+3}a_{j} \} \preceq q_{j}$となる$q_{j}$が考えられる．
よって，$\tilde{G}_{j}$には，それぞれ1本の辺が含まれる．
$G$に含まれる辺は，9本であるから，残り$9-2=7$本の辺は$\tilde{G}_{i}$ $(i=1, \ldots, k-3)$と$\tilde{G}_{k}$に含まれる．
$\tilde{G}_{i}$のいずれかに，辺が1本以上含まれる場合，$p \{ x:=ab \} \preceq q_{i}$ $(a \not = a_{i}$かつ$b \not = a_{i})$となる．
補題\ref{追加部分}より，$p \{ x:=xy \} \preceq q_{i}$となる
これは，仮定に矛盾する．
よって，$\tilde{G}_{k}$には$7$本の辺が含まれる．
ある$\tilde{G}_{i}$に含まれる辺が5本以上であるとき，互いに隣接しない辺が3本以上存在する．
補題\ref{補題14}(abc)より，$p \{x:=xy \} \preceq q_{k}$となる．
これは，仮定に矛盾する．

\textbf{(2-3)} 
$p \{ x:=ya_{i} \} \preceq q_{i}$かつ$p \{ x:=a_{i}y \} \preceq q_{i}$ $(i=1, \ldots, k-2)$とし，$p \{ x:=ya_{k+2} \} \preceq q_{k-1}$かつ$p \{ x:=a_{k-1}y \} \preceq q_{k-1}$とする．
このとき，系\ref{両方}より，$p \{ x:=a_{k+2}a_{k-1} \} \preceq q_{k-1}$となる$q_{k-1}$が考えられる．
よって，$\tilde{G}_{k-1}$には，1本の辺が含まれる．
$G$に含まれる辺は，9本であるから，残り$9-1=8$本の辺は$\tilde{G}_{i}$ $(i=1, \ldots, k-2)$と$\tilde{G}_{k}$に含まれる．
$\tilde{G}_{i}$のいずれかに，辺が1本以上含まれる場合，$p \{ x:=ab \} \preceq q_{i}$ $(a \not = a_{i}$かつ$b \not = a_{i})$となる．
補題\ref{追加部分}より，$p \{ x:=xy \} \preceq q_{i}$となる．
これは，仮定に矛盾する．
よって，$\tilde{G}_{k}$には$8$本の辺が含まれる．
ある$\tilde{G}_{i}$に含まれる辺が5本以上であるとき，互いに隣接しない辺が3本以上存在する．
補題\ref{補題14}(abc)より，$p \{x:=xy \} \preceq q_{k}$となる．
これは，仮定に矛盾する．

\textbf{(2-4)} 
$p \{ x:=ya_{i} \} \preceq q_{i}$かつ$p \{ x:=a_{i}y \} \preceq q_{i}$ $(i=1, \ldots, k-1)$とする．
$\tilde{G}_{i}$のいずれかに，辺が1本以上含まれる場合，$p \{ x:=ab \} \preceq q_{i}$ $(a \not = a_{i}$かつ$b \not = a_{i})$となる．
補題\ref{追加部分}より，$p \{ x:=xy \} \preceq q_{i}$となる．
よって，$\tilde{G}_{k}$に$9$本の辺が含まれる．
ある$\tilde{G}_{i}$に含まれる辺が5本以上であるとき，互いに隣接しない辺が3本以上存在する．
補題\ref{補題14}(abc)より，$p \{x:=xy \} \preceq q_{k}$となる．
これは，仮定に矛盾する．

\noindent\textbf{(3)}
$G^{(k-2,~k-2)}$には$4\times4=16$本の辺が含まれる．
$| A^{\prime} \cap B^{\prime} | = 0$であるとき，最大$4$つの$\tilde{G}_{i}$に辺が1本含まれ，$\tilde{G}^{(0,~0)}_{i_{0}}$と$\tilde{G}^{(0,~0)}_{i_{1}}$に，少なくとも$4 \times 4-4=12$本の辺が含まれる．
$12 > 4 \times 2 + 1$より，$\tilde{G}^{(0,~0)}_{i_{0}}$または$\tilde{G}^{(0,~0)}_{i_{1}}$は$5$本以上の辺を含む．
よって，$\tilde{G}^{(0,~0)}_{i_{0}}$または$\tilde{G}^{(0,~0)}_{i_{1}}$は，互いに隣接しない辺を3本以上含む．
したがって，補題\ref{補題14}(abc)より，$p \{x:=xy \} \preceq q_{i_{0}}$または$p \{x:=xy \} \preceq q_{i_{1}}$となる．
これは，仮定に矛盾する．  

$| A^{\prime} \cap B^{\prime} |=0$であるとき，$\tilde{G}^{(0,~0)}_{i_{0}}$と$\tilde{G}^{(0,~0)}_{i_{1}}$に含まれる辺数が最も少なくなる．
よって，$| A^{\prime} \cap B^{\prime} |=0$であるとき，矛盾であれば，$| A^{\prime} \cap B |=n$ $(n=1,2,3,4)$であるときも矛盾する．

一般化して考えていくと，$G$には$\sharp A^{\prime} \times \sharp\tilde{B}^{\prime}$本の辺が含まれる．
$| A^{\prime} \cap B^{\prime} |=0$であるとき，1本の辺を持つ$\tilde{G}^{(1,~1)}_{i_{n}}$ $(n=1,\ldots, \ell$ $(0 \le \ell \le \sharp A^{\prime}))$が最大$\sharp A^{\prime}$個存在する．
このとき，$\tilde{G}^{(0,~0)}_{j_{m}}$ $(m=1,\ldots, \sharp A^{\prime}-2)$には$\sharp A^{\prime} \times \sharp\tilde{B}^{\prime} - \ell$本の辺が含まれる．
よって，$\ell \le \sharp A^{\prime}$より，少なくとも$\sharp A^{\prime} \times \sharp\tilde{B}^{\prime} - \sharp A^{\prime}$本の辺が含まれる．
$\sharp A^{\prime}-2$個の$\tilde{G}^{(0,~0)}_{j_{m}}$に対して，合計$4(\sharp A^{\prime}-2) +1$本の辺を追加していくと，少なくとも1個のグラフは，5本以上の辺を含む．
%\begin{equation*}\label{ine}
  %\begin{split}

\begin{center}
  \begin{tabular}{l}
  $\sharp A^{\prime} \times \sharp\tilde{B}^{\prime} -\sharp A^{\prime} \ge 4(\sharp A^{\prime}-2)+1$\\
  $\sharp A^{\prime 2}-\sharp A^{\prime} \ge 4\sharp A^{\prime}-8+1$\\
%  &\sharp A^{\prime 2}-\sharp A^{\prime}-4\sharp A^{\prime}+7 \ge 0\\
  $\sharp A^{\prime 2}-5\sharp A^{\prime}+7 \ge 0$~~~~~~~~~~~~~~~~~~~~~~~~~(1)
\end{tabular}
\end{center}
  %\end{split}
  %\end{equation*}


(1)式の判別式を$D$とすると，$D=25-4\times7=-3$となる．
$D<0$より，任意の$\sharp A^{\prime}$について不等式が成り立つ．
よって，ある$\tilde{G}^{(0,~0)}_{i}$に含まれる辺は5本以上となり，互いに隣接しない辺が3本以上存在する．
したがって，補題\ref{補題14}(abc)より，$p \{x:=xy \} \preceq q_{i}$となる．
これは，仮定に矛盾する．  

以上より，$k \ge 2$においても，仮定に矛盾する．
\end{proof}

\begin{lem}[Sato et al.\cite{Sato1}]\label{補題15}
$\sharp \Sigma \ge 3$とし，$p,q$を正規パターンとする．
このとき，ある$a \in \Sigma$に対して，
$p \{ x := a \} \preceq q$かつ$p \{ x := xy \} \preceq q$ならば$p \preceq q$である．
ただし，$y$は$q$に含まれない変数記号である．
\end{lem}

\hfill Edited by Takayoshi Shoudai.
\hrule
\bigskip

%\input{sec3thm.tex}
